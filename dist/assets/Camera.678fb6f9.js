import{n as u,s as g}from"./index.ada7859a.js";var p=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"camera-comp"},[e("video",{directives:[{name:"show",rawName:"v-show",value:!t.photo,expression:"!photo"}],ref:"video",staticClass:"video",class:t.facingMode==="user"?"front":""}),e("div",{directives:[{name:"show",rawName:"v-show",value:t.isShowCanvas,expression:"isShowCanvas"}],staticClass:"canvas"},[e("canvas",{ref:"canva"})]),t.photo?e("div",{attrs:{id:"image_text"}},[t.photo?e("img",{staticClass:"cap-photo",attrs:{src:t.photo,alt:"photo",id:"img_prev"}}):t._e(),t._l(t.$store.state.customer.ocrResponseElements,function(a,i){return e("div",{directives:[{name:"show",rawName:"v-show",value:t.photo&&t.$store.state.customer.ocrResponseElements.length>0,expression:"photo && $store.state.customer.ocrResponseElements.length > 0"}],key:i,class:a.selected?"colored-shed bounding-box":"gray-shed bounding-box",style:{top:a.y1+"px",left:a.x1+"px",width:a.x2-a.x1+"px",height:a.y2-a.y1+"px"},on:{click:function(o){return t.getSelectedElement(a)}}})})],2):t._e(),e("b-loading",{attrs:{"is-full-page":t.isFullPage,"can-cancel":!1},model:{value:t.isLoading,callback:function(a){t.isLoading=a},expression:"isLoading"}})],1)},v=[];const f={components:{},data(){return{isShowCanvas:!1,photo:null,image:null,mediaStream:null,videoDevices:[],facingMode:"environment",counter:0,switchingCamera:!1,canva:null,selectedTexts:[],isFullPage:!0,isLoading:!1,reducedSize:0,start:0,end:0,getOcrStart:0,frontImgRes:0,delayTime:3e3,count:0,checkRes:0}},mounted(){this.openCamera()},beforeDestroy(){this.closeCamera()},methods:{async openCamera(){const t=await navigator.mediaDevices.enumerateDevices();this.videoDevices=t.filter(s=>s.kind==="videoinput"),await this.StartRecording("environment")},async StartRecording(t){this.facingMode=t;let s=this.$refs.video;return s.setAttribute("autoplay",""),s.setAttribute("muted",""),s.setAttribute("playsinline",""),this.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:t,width:500,height:500},audio:!1}),s.srcObject=this.mediaStream,await s.play()},ReTakePhoto(){this.photo=null,this.openCamera()},async TakePhoto(){let t=this.$refs.video;this.canva=this.$refs.canva;let s=t.videoWidth,e=t.videoHeight;this.canva.width=s,this.canva.height=e;let a=this.canva.getContext("2d");this.facingMode==="user"&&a.scale(-1,1),a.drawImage(t,0,0,s,e),a.save(),this.photo=this.canva.toDataURL("image/jpeg"),this.closeCamera(),this.start=new Date().getTime(),this.Send()},closeCamera(){const s=this.$refs.video.srcObject;if(s){const e=s.getTracks();e[0].stop(),e.forEach(a=>a.stop())}},async Send(){this.isLoading=!0;let t=new FormData;t.append("awsInstance","t2 samll"),t.append("image",this.photo);let s=new Date().getTime();await this.$store.dispatch("customer/getOCRDataBySchedule",t).then(e=>{if(e.status_code===200&&e.data.status===0){let a=new Date().getTime(),i=a-s,o=a-this.start;this.frontImgRes=o,console.log("frontStart: "+this.start+" ,frontRes: "+o),console.log("ocr request send and response time =start: "+s+" end: "+a+" res time: "+i);let c={id:e.data.id};this.getOcrStart=new Date().getTime(),this.getOCRResult(c)}}).catch(e=>{this.isLoading=!1,g(e.response.data.error+"! "+e.response.data.message,"is-danger")})},getOCRResult(t){this.$store.dispatch("customer/getOCRResult",t).then(s=>{let e=new Date().getTime(),a=e-this.checkRes;if(this.checkRes=e,console.log("ResStart : "+e+" diffRes: "+a),console.log("res er: ",this.delayTime,"count: ",this.count),s.data.status!==1){let r=this;setTimeout(()=>{this.count++,this.count==1?this.delayTime=50:this.count>1&&this.delayTime>20?this.delayTime=this.delayTime-5:this.delayTime=20,console.log("setTimeOut er : ",this.delayTime,"count: ",this.count),r.getOCRResult(t)},this.delayTime)}else{this.delayTime=3e3,this.count=0;let r=new Date().getTime(),l=r-this.getOcrStart;console.log("successResCome : "+r+" ,SuccessResTime : "+l),console.log(s.data.status),this.isLoading=!1,s.data.ocr_data!==null||(this.ReTakePhoto(),g("\u8A8D\u8B58\u6587\u5B57\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3067\u3057\u305F\u3002\u518D\u5EA6\u8A66\u3059\u304B\u691C\u7D22\u6587\u5B57\u3092\u5165\u529B\u304F\u3060\u3055\u3044\u3002","is-danger"));let d={id:0,type:"ocr",photo:this.photo,ocrData:s.data.ocr_data,image:this.canva.toDataURL("image/jpeg")};this.$store.dispatch("global/setCapturedImages",d);let h=s.data.ocr_data;h.length>0?(this.$store.dispatch("customer/setOCROriginalResponse",h),this.makeBoundingBox(h)):g("\u8A8D\u8B58\u6587\u5B57\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3067\u3057\u305F\u3002\u518D\u5EA6\u8A66\u3059\u304B\u691C\u7D22\u6587\u5B57\u3092\u5165\u529B\u304F\u3060\u3055\u3044\u3002","is-danger")}let i=new Date().getTime(),o=i-this.getOcrStart,c=this.frontImgRes+o;console.log("getOcrStart "+this.getOcrStart+" ,getOcrAllEnd : "+i+" , ocrAllResTime : "+o+" ,TotalRes: "+c)}).catch(s=>{this.isLoading=!1,g(s.response.data.error+"! "+s.response.data.message,"is-danger")})},makeBoundingBox(t){let s=[];t.forEach((e,a)=>{let i=[e.bounding_box.x1,e.bounding_box.x2,e.bounding_box.x3,e.bounding_box.x4],o=[e.bounding_box.y1,e.bounding_box.y2,e.bounding_box.y3,e.bounding_box.y4],c=i[0],r=i[0],l=o[0],d=o[0];for(let n=1;n<i.length;n++)i[n]>r?r=i[n]:i[n]<c&&(c=i[n]);for(let n=1;n<o.length;n++)o[n]>d?d=o[n]:o[n]<l&&(l=o[n]);let h={id:a,text:e.text,x1:c*.828,x2:r*.828,y1:l*.828,y2:d*.828,selected:!1};s.push(h)}),this.$store.dispatch("customer/setOCRResponseElements",s)},generateImage(){let t=document.getElementById("img_prev");var s=document.createElement("canvas"),e=s.getContext("2d");s.setAttribute("width",500),s.setAttribute("height",500),e.drawImage(t,0,0,500,500),this.$store.state.customer.ocrResponseElements.forEach((i,o)=>{e.beginPath(),e.rect(i.x1/.828,i.y1/.828,i.x2/.828-i.x1/.828,i.y2/.828-i.y1/.828),i.selected?(e.fillStyle="rgba(14, 177, 232, 0.4)",e.fill(),e.strokeStyle="#0EB1E8",e.stroke()):(e.fillStyle="rgba(255, 255, 255, 0.2)",e.fill(),e.strokeStyle="#fff",e.stroke())});let a=s.toDataURL("image/jpeg");this.$store.dispatch("customer/setBoundingBoxImage",a)},getSelectedElement(t){let s=this.$store.state.customer.ocrResponseSelectedElements.find(e=>e.id===t.id);s?(s.selected=!1,this.$store.state.customer.ocrResponseSelectedElements.splice(this.$store.state.customer.ocrResponseSelectedElements.indexOf(s),1)):(t.selected=!0,this.$store.dispatch("customer/setOCRResponseSelectedElements",t)),this.$emit("getText",this.$store.state.customer.ocrResponseSelectedElements)}}},m={};var R=u(f,p,v,!1,x,"72d57fd9",null,null);function x(t){for(let s in m)this[s]=m[s]}var _=function(){return R.exports}();export{_ as c};
